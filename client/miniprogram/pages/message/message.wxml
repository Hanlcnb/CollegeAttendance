<wxs src="./message.wxs" module="utils" />

<t-notice-bar
  visible="{{hasNotice}}"
  prefixIcon="sound"
  suffixIcon="chevron-right"
  content="{{noticeContent}}"
  t-class="external-class"
  t-class-prefix-icon="external-class-prefix-icon"
></t-notice-bar>
<view class="chat-container {{showExtendPanel ? 'panel-open' : ''}}">
  <scroll-view class="scrollarea" scroll-y="true" scroll-into-view="{{scrollToView}}" scroll-with-animation>
    <view class="message-list">
      <!-- 消息列表 -->
      <view class="message-group" wx:for="{{messages}}" wx:key="index">
        <!-- 时间戳 -->
        <view wx:if="{{ index === 0 || item.createdAt - messages[index - 1].time > 120000 }}" class="time-stamp" >
          {{ utils.formatTime(item.time) }}
        </view>
        
        <!-- 对方的消息 -->
        <view class="message-item other" wx:if="{{item.senderId !== userInfo.userId}}">
          <image class="avatar" src="{{avatar}}" mode="aspectFill"></image>
          <view class="message-content-wrapper">
            <view class="message-content">
              <block wx:if="{{item.type === 'image'}}">
                <image class="message-image" src="{{item.content}}" mode="widthFix" bindtap="previewImage" data-url="{{item.content}}"></image>
              </block>
              <block wx:elif="{{item.type === 'location'}}">
                <view class="location-message" bindtap="openLocation" data-location="{{item.content}}">
                  <view class="location-title">{{item.content.name}}</view>
                  <view class="location-address">{{item.content.address}}</view>
                </view>
              </block>
              <block wx:elif="{{item.type === 'file'}}">
                <view class="file-message" bindtap="downloadFile" data-file="{{item.content}}">
                  <view class="file-icon">
                    <image src="/images/icon/file.png"></image>
                  </view>
                  <view class="file-info">
                    <view class="file-name">{{item.content}}</view>
                  </view>
                </view>
              </block>
              <block wx:elif="{{item.type === 'attend'}}">
                <view class="attend-message" bindtap="goToAttend" data-attendid="{{item.content}}">
                  <view class="attend-title">签到任务 #{{item.content}}</view>
                </view>
              </block>
              <block wx:else>
                <text class="text-content">{{item.content}}</text>
              </block>
            </view>
          </view>
        </view>

        <!-- 我的消息 -->
        <view class="message-item me" wx:else>
          <view class="message-content-wrapper">
            <view class="message-content">
              <block wx:if="{{item.type === 'image'}}">
                <image class="message-image" src="{{item.content}}" mode="widthFix" bindtap="previewImage" data-url="{{item.content}}"></image>
              </block>
              <block wx:elif="{{item.type === 'location'}}">
                <view class="location-message" bindtap="openLocation" data-location="{{item.content}}">
                  <view class="location-title">{{item.content.name}}</view>
                  <view class="location-address">{{item.content.address}}</view>
                </view>
              </block>
              <block wx:elif="{{item.type === 'file'}}">
                <view class="file-message" bindtap="downloadFile" data-file="{{item.content}}">
                  <view class="file-icon">
                    <image src="/images/icon/file.png"></image>
                  </view>
                  <view class="file-info">
                    <view class="file-name">{{item.content.name}}</view>
                    <view class="file-size">{{item.content.size}}</view>
                  </view>
                </view>
              </block>
              <block wx:elif="{{item.type === 'attend'}}">
                <view class="attend-message" bindtap="goToAttend" data-attendid="{{item.content}}">
                  <view class="attend-title">签到任务 #{{item.content}}</view>
                </view>
              </block>
              <block wx:else>
                <text class="text-content">{{item.content}}</text>
              </block>
            </view>
          </view>
          <image class="avatar" src="{{userInfo.avatar}}" mode="aspectFill"></image>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 输入框区域 -->
  <view class="input-area">
    <view class="input-box">
      <input class="message-input" 
             type="text" 
             placeholder="请输入消息" 
             value="{{inputMessage}}"
             bindinput="onInputChange"
             confirm-type="send"
             bindconfirm="sendTextMessage"/>
    </view>
    <view class="button-area">
      <block wx:if="{{inputMessage}}">
          <t-button theme="primary" 
          size="large" 
          icon="send" 
          shape="circular" 
          aria-label="发送"
          bindtap="sendMessage"></t-button>
      </block>
      <block wx:else>
          <t-button theme="primary" 
          size="large" 
          icon="add" 
          shape="circular" 
          aria-label="更多"
          bindtap="showExtendPanel"></t-button>
      </block>
    </view>
  </view>

  <!-- 扩展功能面板 -->
  <view class="extend-panel" wx:if="{{showExtendPanel}}">
    <view class="extend-item" bindtap="chooseImage" hover-class="extend-item-hover">
      <image src="/images/icon/picture.png"></image>
      <text>图片</text>
    </view>
    <view class="extend-item" bindtap="chooseLocation" hover-class="extend-item-hover">
      <image src="/images/icon/location.png"></image>
      <text>位置</text>
    </view>
    <view class="extend-item" bindtap="chooseFile" hover-class="extend-item-hover">
      <image src="/images/icon/file.png"></image>
      <text>文件</text>
    </view>
    <view class="extend-item" bindtap="toAttend" hover-class="extend-item-hover">
      <image src="/images/icon/scan.png"></image>
      <text>人脸签到</text>
    </view>
    <view class="extend-item" 

      bindtap="publishAttend" 
      hover-class="extend-item-hover">
      <image src="/images/icon/more.png"></image>
      <text>发布签到</text>
    </view>
  </view>
</view>